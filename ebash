#!/bin/bash
set -euo pipefail

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
  echo "–û—à–∏–±–∫–∞: –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ TELEGRAM_BOT_TOKEN –∏ TELEGRAM_CHAT_ID!" >&2
  exit 1
fi

# –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [ $# -eq 0 ]; then
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <script.sh> [–∞—Ä–≥—É–º–µ–Ω—Ç—ã...]" >&2
  exit 1
fi

# –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –ª–æ–≥–∞
LOG_FILE=$(mktemp)
trap 'rm -f "$LOG_FILE"' EXIT

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
send_telegram() {
  local message="$1"
  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d "chat_id=${TELEGRAM_CHAT_ID}" \
    -d "text=$message" \
    -d "parse_mode=Markdown" >/dev/null
}

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ä—Ç–µ
COMMAND_NAME=$(basename "$1")
send_telegram "üöÄ *–ó–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç:* \`$COMMAND_NAME\`
üñ• *–•–æ—Å—Ç:* \`$(hostname)\`
üìÇ *–†–∞–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥:* \`$(pwd)\`"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–≤–æ–¥
start_time=$(date +%s)
"$@" 2>&1 | tee "$LOG_FILE"
exit_code=${PIPESTATUS[0]}
end_time=$(date +%s)
duration=$((end_time - start_time))

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞
LOG_TAIL=$(tail -n 5 "$LOG_FILE" | sed 's/^/\n    /')
STATUS_EMOJI="‚úÖ" && [ $exit_code -ne 0 ] && STATUS_EMOJI="‚ùå"

# –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
message="$STATUS_EMOJI *–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω:* \`$COMMAND_NAME\`
‚åõ *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:* ${duration} —Å–µ–∫.
üî¢ *–ö–æ–¥ –≤—ã—Ö–æ–¥–∞:* $exit_code
üìù *–õ–æ–≥ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏):* \`\`\`$LOG_TAIL\`\`\`"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
send_telegram "$message"
exit $exit_code